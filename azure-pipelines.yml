name: $(Date:yyyy.M.d)$(Rev:.r)
trigger:
  branches:
    include:
    - master

variables:
  MyConfiguration: Release
  MyPlatform: Any CPU
  WorkingDirectory: $(build.sourcesDirectory)
  APIName: DevOpsTechChallenge.API
  WebSiteName: DevOpsTechChallenge.Web
  APIDirectory: $(WorkingDirectory)\$(APIName)
  WebSiteDirectory: $(WorkingDirectory)\$(WebSiteName)
  

pool:
  vmImage: 'windows-latest'

jobs:
- job: Build_API
  displayName: Build API
  steps:
  - powershell: .\build.ps1 --Version '$(Build.BuildNumber)' --Configuration '$(MyConfiguration)'
    displayName: Run Nuke Build
    workingDirectory: $(APIDirectory)
  - task: PublishTestResults@2
    displayName: Publish Test Results
    inputs:
      testResultsFormat: 'VSTest'
      testResultsFiles: '**/*.trx'
      searchFolder: '$(APIDirectory)'
      failTaskOnFailedTests: true
      testRunTitle: 'API Build Tests'
      buildPlatform: '$(MyPlatform)'
      buildConfiguration: '$(MyConfiguration)'
  - task: PublishCodeCoverageResults@1
    displayName: Publish Coverage Results
    inputs:
      codeCoverageTool: 'Cobertura'
      summaryFileLocation: '$(APIDirectory)\**\in\**\coverage.cobertura.xml'
      pathToSources: '$(APIDirectory)'
  - task: PublishPipelineArtifact@1
    displayName: Publish Build Artifact
    inputs:
      targetPath: '$(APIDirectory)/$(APIName).zip'
      artifact: 'WebSiteArtifact'
 